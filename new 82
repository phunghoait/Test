
				 select rownum stt,dvc.ten_dv,dv.ten_dv,dv.donvi_id,gp.phieu_id,a.hdtb_id, b.ma_gd,b.ngay_cn,nd.ten_nd,b.nguoi_cn,tonhom.ten_dv nhom_cn,to_char(a.ngay_tt,'dd/mm/yyyy hh24:mi') ngay_tt, to_char(a.ngay_ht,'dd/MM/yyyy hh24:mi') ngay_ht , c.loaihinh_tb
				 ,d.ten_kieuld,Decode (a.diachi_ld, '', a.diachi_tb, a.diachi_ld)  diachi_ld
				 ,to_char(b.ngay_yc, 'dd/MM/yyyy hh24:mi') ngay_yc, to_char(gp.ngaygiao, 'dd/mm/yyyy hh24:mi') ngaygiao,to_char(gp.ngay_th ,'dd/MM/yyyy hh24:mi') ngay_th
				 , css_lci.LAY_TG_XULY(b.ngay_yc,gp.ngaygiao) tg_tiepnhan --lay theo so gio
				 , css_lci.LAY_TG_XULY(b.ngay_yc,gp.ngay_th) tg_thuchien -- lay theo so gio
				 ,list_phieu.ds as nd_tra , a.ma_tb,a.ten_tb,a.ghichu, nv.ten_nv,list.ds as nguoi_th,kv.ten_kv
        if(vdichvuvt_id = 1) then --Co dinh
             ,'' MD1, '' MD4--Modem 1 & 4 cong
             ,'' MD_ADSL, '' MD_SHDSL--Modem danh cho megawan
             ,'' STB_HD, '' STB_SD--Modem danh cho MyTV
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,0,0) may_cd
             , may_gp
             , cpe
        elsif(vdichvuvt_id = 4) then --Internet
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,284,0,1) MD1--Modem 1
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,285,0,1) MD4--Modem  4 cong
             ,MD_ADSL, MD_SHDSL--Modem danh cho megawan
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,30,2) STB_HD--STB HD
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,34,2) STB_SD
             , may_cd
             , may_gp
             , css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,32,2) cpe
        elsif(vdichvuvt_id = 8) then
             , MD1, MD4--Modem 1 & 4 cong
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,334,0,1) MD_ADSL--Modem danh cho megawan
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,336,0,1) MD_SHDSL--Modem danh cho megawan
             , STB_HD, '' STB_SD--Modem danh cho MyTV
             , may_cd
             , may_gp
             , cpe
        elsif(vdichvuvt_id = 10) then
             ,MD1, ' MD4--Modem 1 & 4 cong
             ,MD_ADSL, MD_SHDSL
             ,'' STB_HD, '' STB_SD--Modem danh cho MyTV
             ,'' may_cd
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,0,0) may_gp
             ,'' cpe
        elsif(vdichvuvt_id = 11) then --IMS
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,284,0,1) MD1--Modem 1
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,285,0,1) MD4--Modem  4 cong
             ,'' MD_ADSL, '' MD_SHDSL--Modem danh cho megawan
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,30,2) STB_HD--STB HD
             ,css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,34,2) STB_SD
             ,'' may_cd
             ,'' may_gp
             , css_lci.tracuu_hopdong.lay_thongtin_tbi_hdtb2(a.hdtb_id,0,32,2) cpe
        end if;
         from css_lci.hd_thuebao a, css_lci.hd_khachhang b, css_lci.giaophieu gp, css_lci.hdtb_kv hdkv, css_lci.khuvuc kv, 
         css_lci.loaihinh_tb c ,css_lci.kieu_ld d , admin_lci.nhanvien nv,ADMIN_LCI.NGUOIDUNG nd,ADMIN_LCI.DONVI tonhom,ADMIN_LCI.DONVI dvc,
         (Select * From  admin_lci.donvi start with donvi_id = '||vdonvi_id||' connect by prior donvi_id = donvi_cha_id) dv, 
				 (SELECT a.PHIEU_ID, LISTAGG(b.ten_nv, ' ') 
												WITHIN GROUP (ORDER BY NHANVIEN_TH_ID) as ds
												FROM (SELECT DISTINCT PHIEU_ID, nhanvien_th_id from CSS_LCI.GIAOPHIEU_NV) a 
												join ADMIN_LCI.NHANVIEN b on a.nhanvien_th_id = b.nhanvien_id
												GROUP BY a.PHIEU_ID) list, 
				 (SELECT  a.hdtb_id, LISTAGG(a.nd_tra, ' ') 
												WITHIN GROUP (ORDER BY a.hdtb_id) as ds
												FROM (SELECT DISTINCT hdtb_id, nd_tra from CSS_LCI.GIAOPHIEU 
													WHERE ngaytra is not null and huonggiao_id in (604,605,610)) a 												
												GROUP BY a.hdtb_id) list_phieu  --MinhL thêm ngày 14/05, thêm nội dung các phiếu trả lại
        if(vdichvuvt_id = 1) then --Co dinh
            ,css_lci.hdtb_cd cd
        elsif(vdichvuvt_id = 4) then --Internet
            ,css_lci.hdtb_adsl adsl
        elsif(vdichvuvt_id = 8) then
            ,css_lci.hdtb_mgwan mgw--megawan
        elsif(vdichvuvt_id = 9) then
            ,css_lci.hdtb_tsl tsl--TSL
        elsif(vdichvuvt_id = 10) then
            ,css_lci.hdtb_gp gph--Gphone
        elsif(vdichvuvt_id = 11) then
            ,css_lci.hdtb_ims ims--IMS
        end if;
         where  a.hdkh_id = b.hdkh_id
         and a.loaitb_id = c.loaitb_id
         and a.kieuld_id = d.kieuld_id
				 and a.hdtb_id = hdkv.hdtb_id
				 and hdkv.khuvuc_id	= kv.khuvuc_id
				 and gp.phieu_id	= gnv.phieu_id(+)
			   and gp.phieu_id	= list.phieu_id(+)
				 and a.hdtb_id = list_phieu.hdtb_id(+) --MinhL thêm ngày 14/05
				 and gp.phieu_id	= listND_Tra.phieu_id(+)
         and nv.nhanvien_id = gp.nhanvien_th_id (+)
         and b.nguoi_cn = nd.ma_nd (+)
         and b.donvi_id = tonhom.donvi_id
         and b.loaihd_id = '||vloaihd_id||'
         and Decode('||vloaitb_id||', 0, '||vloaitb_id||', a.loaitb_id) = '||vloaitb_id;
			   and a.hdtb_id	= gp.hdtb_id
        if(vdichvuvt_id = 1) then
             and a.hdtb_id = cd.hdtb_id
             and gp.donvi_nhan_id = dv.donvi_id
        end if;
        if(vdichvuvt_id = 4) then
            and a.hdtb_id = adsl.hdtb_id
            and gp.donvi_nhan_id = dv.donvi_id
            and ADMIN_LCI.LAY_DONVI_CHA(gp.donvi_nhan_id,2) = dvc.donvi_id
        end if;
        if(vdichvuvt_id = 8) then
             and a.hdtb_id = mgw.hdtb_id
             and gp.donvi_nhan_id = dv.donvi_id
             and ADMIN_LCI.LAY_DONVI_CHA(gp.donvi_nhan_id,2) = dvc.donvi_id
        end if;
        if(vdichvuvt_id = 9) then
            str:=str||' and a.hdtb_id = tsl.hdtb_id
            str:=str||' and gp.donvi_nhan_id = dv.donvi_id
            str:=str||' and ADMIN_LCI.LAY_DONVI_CHA(gp.donvi_nhan_id,2) = dvc.donvi_id
        end if;
        if(vdichvuvt_id = 10) then
            and a.hdtb_id = gph.hdtb_id
            and gp.donvi_nhan_id = dv.donvi_id
						and ADMIN_LCI.LAY_DONVI_CHA(gp.donvi_nhan_id,2) = dvc.donvi_id
        end if;
        if(vdichvuvt_id = 11) then
             and a.hdtb_id = ims.hdtb_id
             and gp.donvi_nhan_id = dv.donvi_id
             and ADMIN_LCI.LAY_DONVI_CHA(gp.donvi_nhan_id,2) = dvc.donvi_id
        end if;
       --Lap moi
        if(vloaihd_id =1) then
           if(vdichvuvt_id = 1) then--Lap moi co dinh
                 and gp.huonggiao_id =602
           elsif(vdichvuvt_id = 4) then--Lap moi ADSL
                 and gp.huonggiao_id in (604,605,610)
           elsif(vdichvuvt_id = 8) then--Lap moi Megawan
                 and gp.huonggiao_id =607
           elsif(vdichvuvt_id = 9) then--Lap moi TSL
                 and gp.huonggiao_id =608
           elsif(vdichvuvt_id = 11) then--Lap moi IMS
                 and gp.huonggiao_id =603
           end if;
        end if;
        --Di chuyen
        if(vloaihd_id = 3) then
           if(vdichvuvt_id = 1) then--Dich chuyen co dinh
                 and gp.huonggiao_id=621
           end if;
           if(vdichvuvt_id = 4) then--Dich chuyen ADSL
                 and gp.huonggiao_id in (623,624,628)
           end if;
           if(vdichvuvt_id = 8) then--Dich chuyen Megawan
                 and gp.huonggiao_id=626
           end if;
           if(vdichvuvt_id = 9) then--Dich chuyen TSL
                 and gp.huonggiao_id=627
           end if;
        end if;

        if(vloaihd_id = 6) then --Chuyen doi loai hinh thue bao
         if(vdichvuvt_id = 1) then--CDLH Co dinh
                 and gp.huonggiao_id =640
           end if;
         if(vdichvuvt_id = 9) then--CDLH TSL
                 and gp.huonggiao_id =639
           end if;
           if(vdichvuvt_id = 4) then--CDLH Internet
                 and gp.huonggiao_id in (636,637)
           end if;
           if(vdichvuvt_id = 8) then--CDLH Megawan
                 and gp.huonggiao_id=638
           end if;
        end if;

        if(vloaihd_id = 4) then --Hop dong thanh ly
           if(vdichvuvt_id = 1) then--Thanh ly co dinh
                 and gp.huonggiao_id in (726,733) 
           end if;
           if(vdichvuvt_id = 4) then--Thanh ly Internet
                 and gp.huonggiao_id in (334,327) 
           end if;
           if(vdichvuvt_id = 8) then--Thanh ly Megawan
                 and gp.huonggiao_id in (330,730) 
           end if;
           if(vdichvuvt_id = 9) then--Thanh ly TSL
                 and gp.huonggiao_id in (731,736) 
           end if;
           if(vdichvuvt_id = 11) then--Thanh ly IMS
                 and gp.huonggiao_id in (728,738) 
           end if;
        end if;

        if(vloaihd_id = 5) then --Thay doi thong so megawan
                 and gp.huonggiao_id =720
        end if;

        if(vloaihd_id = 7) then --Hop dong thay doi dich vu (mo khoa theo yc)
           if(vdichvuvt_id = 1) then-- thay doi dich vu co dinh
                 and gp.huonggiao_id = 248 
           end if;
           if(vdichvuvt_id = 11) then --thay doi dich vu IMS
                 and gp.huonggiao_id = 249 
           end if;
        end if;

        if(vloaihd_id = 8) then --Thay doi toc do ineternet
            and gp.huonggiao_id in (718,717,316)  -- chi ap dung doi thue bao mytv
        end if;

        if(vloaihd_id = 14) then --Doi so co dinh hoac Account
                 and gp.huonggiao_id =306
        end if;

        if(vloaihd_id = 16) then --Thay doi toc do TSL
                 and gp.huonggiao_id =721
        end if;

        if(vkieu = 0) then--Lay tat ca
                 and a.tthd_id in (4,5,6)
                 and a.ngay_ht >= TO_DATE('||vngay_bd||' 00:00:00','DD/MM/YYYY HH24:MI:SS')
                 and a.ngay_ht <= TO_DATE('||vngay_kt||' 23:59:59','DD/MM/YYYY HH24:MI:SS')
        elsif (vkieu = 1) then
                 and a.tthd_id in (4)
                 and a.ngay_tt >= TO_DATE('||vngay_bd||' 00:00:00','DD/MM/YYYY HH24:MI:SS')
                 and a.ngay_tt <= TO_DATE('||vngay_kt||' 23:59:59','DD/MM/YYYY HH24:MI:SS')
        elsif (vkieu = 2) then
                 and a.tthd_id in (5,6)
                 and a.ngay_ht >= TO_DATE('||vngay_bd||' 00:00:00','DD/MM/YYYY HH24:MI:SS')
                 and a.ngay_ht <= TO_DATE('||vngay_kt||' 23:59:59','DD/MM/YYYY HH24:MI:SS')
        end if;
                 and Decode('||vkieutb_id||', 0,'||vkieutb_id||', css_lci.LAY_THUEBAO_KM(a.hdtb_id,'||vkieutb_id||')) = '||vkieutb_id;
                 and gp.loaipt_id not in(2,3)